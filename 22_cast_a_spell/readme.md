# å¦‚ä½•æ„å»ºé­”æ³•è¡¨ï¼ˆSpellï¼‰

é­”æ³•ä¹¦ï¼ˆSpellbookï¼‰æ˜¯ä¸€ä¸ªç”± Dune ç¤¾åŒºå…±åŒå»ºè®¾çš„æ•°æ®è½¬æ¢å±‚ã€‚é­”æ³•è¡¨ï¼ˆSpellï¼‰æ˜¯Duneå›¢é˜Ÿå’Œç¤¾åŒºç”¨æˆ·å…±åŒå‚ä¸æ„å»ºè€Œæˆçš„é«˜çº§æŠ½è±¡è§†å›¾æˆ–è¡¨æ ¼ã€‚

é€šè¿‡æ„å»ºé­”æ³•è¡¨ï¼Œæ‰€æœ‰Duneç¤¾åŒºç”¨æˆ·éƒ½å¯ä»¥æ›´ä¾¿æ·åœ°å®Œæˆæ•°æ®åˆ†æã€‚æ„å»ºé­”æ³•æœ‰è¯¸å¤šå¥½å¤„ã€‚æƒ³è±¡ä¸€ä¸‹ä¸‹åˆ—æƒ…å½¢ï¼š
- ä½ æœ‰å¤šä¸ªæŸ¥è¯¢åŒ…å«ç›¸åŒçš„å­æŸ¥è¯¢æˆ–è€…CTE
- ä½ çš„å¤šä¸ªæŸ¥è¯¢ä¸­é‡å¤ä½¿ç”¨äº†éå¸¸é•¿çš„é™æ€æ•°æ®åˆ—è¡¨
- ä½ çš„æŸä¸ªæŸ¥è¯¢è¢«å¤šæ¬¡åˆ†å‰ï¼ˆForkï¼‰æˆ–è€…å¤åˆ¶
- ä½ çš„æŸ¥è¯¢ä¸­åŒ…å«ååˆ†å¤æ‚çš„è¿ç®—é€»è¾‘ï¼Œè¿™ä¸ªæŸ¥è¯¢å¯ä»¥åœ¨å…¶ä»–åœ°æ–¹é‡ç”¨

åœ¨ä»¥ä¸Šè¿™äº›æƒ…å½¢ä¹‹ä¸€æ»¡è¶³æ—¶ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥é€šè¿‡æ„å»ºé­”æ³•è¡¨çš„æ–¹å¼ï¼Œå°†è¿™ä¸ªæŸ¥è¯¢è½¬åŒ–ä¸ºä¸€ä¸ªé­”æ³•è¡¨ã€‚è¿™æ ·å¯ä»¥ç®€åŒ–æŸ¥è¯¢ä»£ç é€»è¾‘ï¼Œæé«˜ä¸€è‡´æ€§å’Œå¯ç»´æŠ¤æ€§ï¼Œæå‡æ•°æ®æŒ‡æ ‡çš„æ¸…æ™°åº¦ã€‚

Duneå¼€æºçš„é­”æ³•ä¹¦é¡¹ç›®å¯è‡ªåŠ¨æ„å»ºå¹¶ç»´æŠ¤è¿™äº›é­”æ³•è¡¨æ ¼ã€‚æˆ‘ä»¬ç¤¾åŒºä¸­çš„ä»»ä½•äººéƒ½å¯ä»¥è´¡çŒ®é­”æ³•ä¹¦ä¸­çš„é­”æ³•è¡¨ã€‚æœ¬ç¯‡æ•™ç¨‹æˆ‘ä»¬å°è¯•ç¼–å†™ä¸€ä¸ªç®€å•çš„é­”æ³•è¡¨ã€‚

## æ„å»ºé­”æ³•è¡¨çš„åŸºæœ¬æ­¥éª¤

æ„å»ºé­”æ³•è¡¨çš„åŸºæœ¬æ­¥éª¤åŒ…æ‹¬ï¼š
- **ç¡®å®šæ•°æ®å¯¹è±¡**ï¼šæ ¹æ®å‰è¿°ä¸¾ä¾‹çš„æƒ…å½¢ï¼Œç»“åˆè‡ªå·±æˆ–è€…å…¶ä»–ç¤¾åŒºç”¨æˆ·åœ¨ç¼–å†™æŸ¥è¯¢æ—¶çš„å…·ä½“æƒ…å†µï¼Œç¡®å®šè¦å¤„ç†ä¸ºé­”æ³•è¡¨çš„æ•°æ®å¯¹è±¡ã€‚ä¸ºè¦è¾“å‡ºçš„é­”æ³•è¡¨å®šä¹‰æ¨¡å¼ï¼ˆSchemaï¼‰ã€‚
- **é…ç½®æ•°æ®æº**ï¼šæ•°æ®æºæ˜¯æŒ‡æ„å»ºé­”æ³•è¡¨æ‰€ä¾èµ–çš„åŸå§‹æ•°æ®è¡¨å’Œè§£ç æ•°æ®è¡¨ã€‚å®ƒä»¬å¿…é¡»è¢«å®šä¹‰åˆ°YAMLæ–‡ä»¶ä¸­ã€‚æ¯ä¸€ä¸ªæ•°æ®æºåœ¨é­”æ³•è¡¨ä¸­åªéœ€å®šä¹‰ä¸€æ¬¡ã€‚
- **ç¼–å†™æµ‹è¯•**ï¼šå¼€å§‹ç¼–å†™é­”æ³•è¡¨ä¹‹å‰å…ˆè€ƒè™‘å¥½éœ€è¦çš„ç»“æœï¼Œé’ˆå¯¹è¯¥ç»“æœç¼–å†™ç›¸åº”çš„æµ‹è¯•ã€‚å½“ç„¶å¦‚æœæˆ‘ä»¬çš„é­”æ³•è¡¨åªæ˜¯ä¸€ä¸ªèšåˆæ•°æ®çš„è§†å›¾ï¼Œæµ‹è¯•ä¹Ÿå¯ä»¥æ”¾åˆ°ç¼–å†™å¥½é­”æ³•è¡¨åé¢æ¥æ·»åŠ ã€‚
- **ç¼–å†™é­”æ³•è¡¨**ï¼šä¸ºæ¯ä¸€ä¸ªè¦æ„å»ºçš„é­”æ³•è¡¨åœ¨å…¶ç‹¬æœ‰çš„`.sql`æ–‡ä»¶ä¸­é€šè¿‡ç¼–å†™åŒ…å«ä¸€å®šç‰¹æ®Šæ ¼å¼ï¼ˆJINJAæ¨¡ç‰ˆï¼‰çš„`SELECT`æŸ¥è¯¢æ¥æ„å»ºé­”æ³•è¡¨ã€‚å¯¹é­”æ³•è¡¨è¿›è¡Œç¼–è¯‘å’Œæµ‹è¯•ã€‚
- **æäº¤PR**ï¼šç¼–å†™å¥½é­”æ³•è¡¨ï¼Œæœ¬åœ°ç¼–è¯‘æˆåŠŸï¼Œæµ‹è¯•é€šè¿‡åï¼Œåœ¨githubåˆ›å»ºæ–°çš„PRï¼ˆPull Requestï¼‰ï¼Œç­‰å¾…Duneå›¢é˜Ÿçš„æŠ€æœ¯äººå‘˜reviewå’Œåˆå¹¶ã€‚æˆåŠŸåˆå¹¶åï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨æŸ¥è¯¢ç¼–è¾‘å™¨ä¸­æ‰¾åˆ°æ–°å»ºçš„é­”æ³•è¡¨äº†ã€‚

Duneçš„åœ¨çº¿æ–‡æ¡£æœ‰æ›´è¯¦ç»†çš„è¯´æ˜ï¼š[é­”æ³•ä¹¦å…¥é—¨](https://dune.com/docs/zh/spellbook/getting-started/)

## æ„å»ºé­”æ³•è¡¨å‰çš„å‡†å¤‡å·¥ä½œ

å¼€å§‹æ„å»ºé­”æ³•è¡¨ä¹‹å‰ï¼Œä½ éœ€è¦åšä¸€äº›å¿…å¤‡çš„å‡†å¤‡å·¥ä½œï¼ŒåŒ…æ‹¬ç†Ÿæ‚‰dbt å·¥å…·çš„åŸºæœ¬ä½¿ç”¨ï¼Œç†Ÿæ‚‰github çš„åŸºæœ¬æ“ä½œï¼ˆå¿…é¡»æœ‰githubè´¦å·ï¼‰ï¼Œé…ç½®æœ¬åœ°å·¥ä½œç¯å¢ƒç­‰ã€‚è¯¦ç»†çš„ç¯å¢ƒé…ç½®è¦æ±‚å’Œè¯´æ˜åœ¨è¿™é‡Œï¼š

[ğŸ’» å‡†å¤‡ä¸€äº›å…ˆå†³æ¡ä»¶å¹¶ä¸”è®¾ç½®å¥½é­”æ³•ä¹¦ dbt](https://dune.com/docs/zh/spellbook/how-to-cast-a-spell/1-do-some-prerequisites%20and-set-up-Spellbook-dbt/)

è¿™é‡Œå‡è®¾ä½ å·²ç»æŒ‰ç…§é“¾æ¥é‡Œé¢çš„è¯´æ˜é…ç½®å¥½ç›¸å…³è½¯ä»¶ã€‚ä¸”å·²ç»åœ¨githubä¸Šé€šè¿‡åˆ†å‰ï¼ˆForkï¼‰å°†Duneé­”æ³•ä¹¦å­˜è´®åº“ï¼ˆhttps://github.com/duneanalytics/spellbookï¼‰åˆ†å‰åˆ°äº†ä½ è‡ªå·±çš„githubè´¦å·ä¸‹ã€‚æ¥ä¸‹æ¥çš„é‡ç‚¹æ­¥éª¤ç®€è¦è¯´æ˜ã€‚æˆ‘æœ¬åœ°æ˜¯Macæ“ä½œç³»ç»Ÿï¼Œæ‰€ä»¥è¿™é‡Œä»…ä»¥Macç¯å¢ƒä¸ºä¾‹ã€‚å¦‚æœä½ ç”¨çš„æ˜¯Windowsç¯å¢ƒï¼Œä½¿ç”¨è¿‡ç¨‹é‡åˆ°ä»»ä½•é—®é¢˜ï¼Œè¯·åœ¨ç¾¤é‡Œæé—®ã€‚

ä½¿ç”¨`git clone`å‘½ä»¤å°†åˆ†å‰çš„å­˜è´®åº“å…‹éš†åˆ°æœ¬åœ°ã€‚åœ¨æœ¬åœ°æ–°å»ºä¸€ä¸ªå·¥ä½œç›®å½•ã€‚è¿›å…¥è¯¥ç›®å½•ï¼Œä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤è¿›è¡ŒCloneï¼ˆåœ°å€ä»githubä¸Šä½ è‡ªå·±åˆ†å‰çš„å­˜è´®åº“é¡µé¢å¤åˆ¶ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼‰ï¼š

```
git clone git@github.com:springzh/spellbook.git
```

![image_00.jpg](img/image_00.jpg)

å…‹éš†å®Œæˆåï¼Œå·¥ä½œç›®å½•ä¸­ä¼šçœ‹åˆ°ä¸€ä¸ªæ–°çš„`spellbook`å­ç›®å½•ã€‚è¿›å…¥è¯¥å­ç›®å½•ã€‚

```
cd spellbook
```

å¦‚æœä¹‹å‰æ²¡æœ‰è¿è¡Œè¿‡`pipenv install`æ¥åˆ›å»ºæœ¬åœ°çš„pipenvç¯å¢ƒï¼Œåˆ™éœ€è¦æ‰§è¡Œå®‰è£…ã€‚

```
pipenv install
```

å¦‚æœä¸Šé¢çš„å‘½ä»¤æ‰§è¡Œå‡ºé”™ï¼Œå¯ä»¥å°è¯•ï¼š

```
sudo -H pip install -U pipenv
```

å¦‚æœä¸Šè¿°å‘½ä»¤è¿”å›é”™è¯¯ï¼š

```
pipenv install returns warning LANG, warning Python 3.9 not found
```

é‚£ä¹ˆå¯ä»¥å†æ¬¡å°è¯•æŒ‡å®šPython ç‰ˆæœ¬çš„æ–¹å¼æ¥å®‰è£…ï¼š

```
pipenv install --python 3.9.13
```

å¯ä»¥ä½¿ç”¨è¿™ä¸ªå‘½ä»¤æ¥ç¡®è®¤ä½ æœ¬åœ°å®‰è£…çš„Pythonç‰ˆæœ¬ï¼š

```
python3 â€“version
```

pipenvç¯å¢ƒå®‰è£…å¥½ä¹‹åï¼Œç°åœ¨å°±å¯ä»¥å¯åŠ¨å®ƒäº†ã€‚

```
pipenv shell
```

æ¥ä¸‹æ¥ï¼Œè¿è¡Œ`dbt init`å‘½ä»¤æ¥åˆå§‹åŒ–dbtã€‚è¯¥å‘½ä»¤ä»¥äº¤äº’å¼æ–¹å¼å¼•å¯¼æˆ‘ä»¬å®Œæˆdbtçš„åˆå§‹åŒ–ï¼Œå‰é¢â€œå‡†å¤‡ä¸€äº›å…ˆå†³æ¡ä»¶å¹¶ä¸”è®¾ç½®å¥½é­”æ³•ä¹¦ dbtâ€é“¾æ¥é‡Œæœ‰è¯¦ç»†çš„è¯´æ˜ã€‚

```
dbt init
```

å½“æˆ‘ä»¬ç¼–å†™å¥½é­”æ³•è¡¨åï¼Œæˆ–è€…åœ¨æ¯æ¬¡æˆ‘ä»¬å¯¹é­”æ³•è¡¨çš„ç›¸å…³æ–‡ä»¶è¿›è¡Œäº†ä»»ä½•ä¿®æ”¹ä¹‹åï¼Œæˆ‘ä»¬ä½¿ç”¨`dbt compile`æ¥ç¼–è¯‘æ•´ä¸ªdbté¡¹**ç›®ï¼Œé‡æ–°ç”Ÿæˆé­”æ³•è¡¨çš„SQLã€‚

ä¸ºé¿å…æ··æ·†ï¼Œå†æ¬¡åˆ—ä¸€ä¸‹ä¸»è¦çš„æ­¥éª¤ï¼š

**ç¬¬ä¸€æ¬¡åˆå§‹åŒ–å¹¶è¿è¡Œ**ï¼š

```
# å®‰è£…pipenv ç¯å¢ƒ
pipenv install

# å¯åŠ¨ pipenv ç¯å¢ƒ
pipenv shell 

# åˆå§‹åŒ– dbt
dbt init 

# æ·»åŠ ã€ä¿®æ”¹æ–‡ä»¶

# ç¼–è¯‘ dbt
dbt compile
```

**æ—¥å¸¸è¿è¡Œ**ï¼š

```
# å¯åŠ¨ pipenv ç¯å¢ƒ
pipenv shell 

# æ·»åŠ ã€ä¿®æ”¹æ–‡ä»¶

# ç¼–è¯‘ dbt
dbt compile
```

åœ¨ç¼–å†™ã€è°ƒè¯•ä¸€ä¸ªæ–°çš„é­”æ³•è¡¨è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦åå¤è°ƒæ•´ä¿®æ”¹ç›¸å…³çš„æ–‡ä»¶ï¼Œå¯ä»¥å¤šæ¬¡æ‰§è¡Œdbt compileã€‚å¦‚æœç¼–è¯‘å‡ºé”™ï¼Œæ ¹æ®é”™è¯¯ä¿¡æ¯è¿›è¡Œä¿®æ”¹ã€‚ç¼–è¯‘æˆåŠŸï¼Œåˆ™å¤åˆ¶ç”Ÿæˆçš„SQLè¯­å¥åˆ°Duneä¸Šè¿›è¡Œå®é™…çš„æŸ¥è¯¢æµ‹è¯•ï¼Œç¡®è®¤SQLå·¥ä½œæ­£å¸¸ä¸”è¾“å‡ºç»“æœç¬¦åˆé¢„æœŸã€‚

## æœ¬æ•™ç¨‹è¦æ„å»ºçš„é­”æ³•è¡¨

æœ¬æ•™ç¨‹çš„ç›®çš„æ˜¯æŠ›ç –å¼•ç‰ï¼Œè®©å¤§å®¶å¯ä»¥é€šè¿‡å¾ˆç®€å•çš„ä¾‹å­å¿«é€Ÿä¸Šæ‰‹æ„å»ºé­”æ³•è¡¨ã€‚ä¹‹å‰åœ¨BNBé“¾ä¸Šçš„Space IDåˆšæ¨å‡ºåŸŸåæ³¨å†Œæ—¶ï¼Œæˆ‘æ›¾ç»åˆ›å»ºäº†ä¸€ä¸ª[SpaceIDæ•°æ®çœ‹æ¿](https://dune.com/sixdegree/bnb-domain-spaceid)ã€‚è®°å¾—å½“æ—¶åªæ˜¯å°èŒƒå›´å¼€æ”¾Mintæƒé™ï¼Œç”¨æˆ·å¯¹ç›¸å…³çš„è§„åˆ™æå‡ºäº†å¾ˆå¤šåé¦ˆå»ºè®®ã€‚ç›¸åº”çš„ï¼ŒSpaceIDé¡¹ç›®æ–¹é’ˆå¯¹è¿™äº›åé¦ˆå»ºè®®ä¹Ÿä¸æ–­å¯¹å…¶æ™ºèƒ½åˆçº¦è¿›è¡Œäº†å®Œå–„å‡çº§ï¼ŒçŸ­çŸ­å‡ å¤©æ—¶é—´å†…ï¼ŒåŸŸåæ³¨å†Œçš„åˆçº¦å‘å¸ƒäº†5ä¸ªä¸»è¦ç‰ˆæœ¬ï¼Œä» V3 åˆ° V7ã€‚è¿™å°±å¯¼è‡´äº†ä¸€ä¸ªé—®é¢˜ï¼Œå½“æˆ‘ä»¬è¦æ±‡æ€»å½“å‰å·²ç»è¢«æ³¨å†Œçš„æ‰€æœ‰SpaceIDåŸŸåæ•°æ®æ—¶ï¼Œå°±å¿…é¡»åˆ†åˆ«ä»è¿™äº›ä¸åŒç‰ˆæœ¬æ™ºèƒ½åˆçº¦çš„äº‹ä»¶æ—¥å¿—è¡¨æ¥æŸ¥è¯¢æ•°æ®å¹¶è‡ªè¡Œä½¿ç”¨â€œUnion Allâ€çš„æ–¹å¼åˆå¹¶åˆ°ä¸€èµ·ã€‚æ‰€ä»¥å¤§å®¶å¦‚æœå»çœ‹æˆ‘è¿™ä¸ªæ•°æ®çœ‹æ¿çš„æŸ¥è¯¢æºä»£ç ï¼Œé‡Œé¢çš„æŸ¥è¯¢åŸºæœ¬éƒ½æœ‰ä¸€ä¸ªå¾ˆé•¿çš„CTEå®šä¹‰æ¥æ±‡æ€»åˆå¹¶æ¥è‡ªä¸åŒç‰ˆæœ¬åˆçº¦çš„åŸŸåæ³¨å†Œäº‹ä»¶ã€‚ä¾‹å¦‚ï¼š[https://dune.com/queries/1239514/2124307](https://dune.com/queries/1239514/2124307)ã€‚ä¸ºäº†ä¿æŒæ›´æ–°ï¼Œæˆ‘ä¸å¾—ä¸å¤šæ¬¡å¯¹ç›¸å…³çš„æŸ¥è¯¢é€ä¸ªè¿›è¡Œä¿®æ”¹ï¼Œå°†æ–°çš„åˆçº¦ç‰ˆæœ¬çš„æ•°æ®åŒ…æ‹¬è¿›å»ã€‚å®é™…ä¸Šï¼Œç›®å‰SpaceID å·²ç»æœ‰V8å’ŒV9çš„åŸŸåæ³¨å†Œåˆçº¦ç‰ˆæœ¬ï¼Œè€Œæˆ‘è¿™ä¸ªçœ‹æ¿å¹¶æœªåŒ…æ‹¬å®ƒä»¬çš„æ•°æ®ï¼Œå·²ç»è¿‡æ—¶ã€‚å¦‚æœæœ‰å…¶ä»–ç”¨æˆ·Forkäº†æˆ‘çš„æŸ¥è¯¢å¹¶ä¸”åšäº†ä¸€äº›è°ƒæ•´ï¼Œé‚£ä¹ˆå¾ˆä¸å¹¸ï¼Œä»–ä»¬çš„æŸ¥è¯¢ä¹Ÿè¿‡æ—¶äº†ã€‚

![image_01.jpg](img/image_01.jpg)

å¯¹äºè¿™ç§æƒ…å†µï¼Œå¦‚æœæˆ‘ä»¬å°†åŸŸåæ³¨å†Œäº‹ä»¶æ„å»ºä¸ºä¸€ä¸ªé­”æ³•è¡¨ï¼ˆå®é™…ä¸Šæ˜¯ä¸€ä¸ªè§†å›¾ï¼‰ï¼Œé‚£ä¹ˆæ‰€æœ‰çš„æŸ¥è¯¢éƒ½å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™ä¸ªé­”æ³•è¡¨æ¥ç¼–å†™ã€‚å½“æœ‰æ–°çš„æ™ºèƒ½åˆçº¦ç‰ˆæœ¬å‘å¸ƒæ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦ä¿®æ”¹æ›´æ–°é­”æ³•è¡¨çš„å®šä¹‰ï¼Œé‡æ–°æäº¤PRå»reviewã€‚æäº¤çš„PRè¢«å®¡æ ¸é€šè¿‡å¹¶ä¸”åˆå¹¶ä¹‹åï¼Œé­”æ³•è¡¨çš„æ•°æ®å°±è‡ªåŠ¨æ›´æ–°äº†ã€‚æ‰€æœ‰ä½¿ç”¨è¿™ä¸ªé­”æ³•è¡¨çš„æŸ¥è¯¢éƒ½ä¸éœ€è¦ä»»ä½•æ”¹åŠ¨ã€‚åä¹‹ï¼Œåœ¨æ²¡æœ‰é­”æ³•è¡¨çš„æƒ…å†µä¸‹ï¼Œæˆ‘çš„è¿™äº›æ‰€æœ‰æŸ¥è¯¢ï¼ŒåŒ…æ‹¬å…¶ä»–äººForkè¿™äº›æŸ¥è¯¢ç”Ÿæˆçš„æ–°æŸ¥è¯¢ï¼Œéƒ½å¿…é¡»é€ä¸ªä¿®æ”¹ã€‚ä»è¿™é‡Œæˆ‘ä»¬å¯ä»¥å……åˆ†çœ‹åˆ°æ„å»ºé­”æ³•è¡¨çš„å¥½å¤„ã€‚

æ‰€ä»¥ï¼Œæˆ‘ä»¬è¿™é‡Œè¦åšçš„å°±æ˜¯é’ˆå¯¹`bnb`åŒºå—é“¾ä¸Šçš„`spaceid`é¡¹ç›®ï¼Œæ„å»ºä¸€ä¸ªåŸŸåæ³¨å†Œçš„é­”æ³•è¡¨ã€‚å‚è€ƒENSåŸŸåæ³¨å†Œçš„é­”æ³•è¡¨çš„å‘½åï¼Œæˆ‘ä»¬çš„é­”æ³•è¡¨ï¼ˆè§†å›¾ï¼‰çš„åç§°ç¡®å®šä¸º`view_registrations`ã€‚

## åˆ›å»ºç›®å½•ç»“æ„å’Œæ–‡ä»¶

ç¡®å®šäº†è¦åˆ¶ä½œä»€ä¹ˆé­”æ³•è¡¨ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥ç€æ‰‹å¼€å§‹å·¥ä½œäº†ã€‚æ€»æ˜¯åœ¨å·¥ä½œåˆ†æ”¯ä¸­è¿›è¡Œå¼€å‘æ˜¯ä¸€ä¸ªå¥½ä¹ æƒ¯ï¼Œå»ºè®®å¤§å®¶éƒ½éµå¾ªè¿™ä¸ªæ–¹å¼ã€‚æˆ‘ä»¬åœ¨å·²ç»å…‹éš†åˆ°æœ¬åœ°çš„spellbook å­˜è´®åº“ä¸­æ–°å»ºä¸€ä¸ªå·¥ä½œåˆ†æ”¯ï¼š

```
git checkout -b add_bnb_spaceid
```

ç°åœ¨æˆ‘ä»¬å°±è‡ªåŠ¨åˆ‡æ¢åˆ°äº†`add_bnb_spaceid`è¿™ä¸ªæ–°å»ºçš„git å·¥ä½œåˆ†æ”¯ä¸‹ã€‚å¯ä»¥å¼€å§‹åˆ›å»ºé­”æ³•è¡¨éœ€è¦çš„ç›®å½•ç»“æ„å’Œæ–‡ä»¶ã€‚

é¡¹ç›®ç±»å‹çš„é­”æ³•è¡¨ï¼Œéƒ½æŒ‰é¡¹ç›®åç§°ã€åŒºå—é“¾åç§°çš„ç»“æ„å­˜å‚¨åœ¨ /spellbook/models ç›®å½•ä¸­ã€‚åç§°å…¨éƒ¨ä½¿ç”¨å°å†™å­—æ¯ï¼Œå•è¯ä¹‹é—´ç”¨ `_` åˆ†éš”ã€‚ä¾‹å¦‚ï¼š`/spellbook/models/[project_name]/[blockchain_name]`ã€‚æˆ‘ä»¬è¦æ„å»ºé­”æ³•è¡¨çš„é¡¹ç›®åç§°æ˜¯`spaceid`ï¼ŒåŒºå—é“¾æ˜¯`bnb`ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™ä¸ªé­”æ³•è¡¨çš„å®Œæ•´ç›®å½•ç»“æ„å°±æ˜¯ï¼š`/spellbook/models/spaceid/bnb/`ã€‚

è¯·è¿›å…¥`models`ç›®å½•ï¼Œåœ¨å…¶ä¸‹åˆ›å»ºå­ç›®å½•`spaceid`ï¼Œå†è¿›å…¥è¿™ä¸ªæ–°å»ºçš„ç›®å½•ä¸­åˆ›å»º`bnb`å­ç›®å½•ã€‚

é­”æ³•è¡¨æ–‡ä»¶å‘½åå¦‚ä¸‹ï¼š
- å¯¹äºæ¨¡å¼æ–‡ä»¶ï¼š[project_name]_[blockchain]_schema.yml
- å¯¹äºä¾èµ–æºæ–‡ä»¶ï¼š[project_name]_[blockchain]_sources.yml
- å¯¹äºé­”æ³•è¡¨çš„SQLæ–‡ä»¶ï¼š[project_name]_[blockchain]_[spell_name].sql

å…¶ä¸­ï¼Œ`spell_name`æ˜¯æˆ‘ä»¬æƒ³åˆ›å»ºçš„é­”æ³•è¡¨çš„åç§°ã€‚å› ä¸ºæˆ‘ä»¬è¦å¤„ç†çš„åŸŸåçš„æ³¨å†Œä¿¡æ¯ï¼Œå‚è€ƒENSçš„ç›¸å…³é­”æ³•è¡¨ï¼Œæˆ‘ä»¬å°†åç§°å®šä¸º`view_registrations`ã€‚

æ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨`spaceid/bnb/`ç›®å½•ä¸­åˆ†åˆ«åˆ›å»ºä»¥ä¸‹3ä¸ªå¯¹åº”çš„æ–‡ä»¶ï¼ˆæ–‡ä»¶å†…å®¹å…ˆä¿æŒä¸ºç©ºï¼Œç¨åæˆ‘ä»¬é€ä¸ªè®²è§£ï¼‰ï¼š
- spaceid_bnb_schema.yml
- spaceid_bnb_sources.yml
- spaceid_bnb_view_registrations.sql

ç°åœ¨çš„ç›®å½•å’Œæ–‡ä»¶ç»“æ„å¦‚ä¸‹ï¼š

![image_02.jpg](img/image_02.jpg)

å‚è€ƒæ–‡æ¡£ï¼š[ğŸ›£ï¸ ä¸º SQLã€æ¨¡å¼å’Œæºæ–‡ä»¶è®¾ç½®æ–‡ä»¶ç»“æ„](https://dune.com/docs/zh/spellbook/how-to-cast-a-spell/3-set-up-your-file-structure-for-SQL-schema-and-source-files/)

## å®šä¹‰ä¾èµ–æºæ–‡ä»¶

æˆ‘ä»¬è¿™é‡Œåªéœ€è¦ç”¨åˆ°SpaceIDé¡¹ç›®åˆ°ç›®å‰ä¸ºæ­¢å·²å‘å¸ƒçš„åˆçº¦`RegistrarController`çš„ä¸ƒä¸ªä¸åŒç‰ˆæœ¬çš„å·²è§£æè¡¨ã€‚è¿™äº›è¡¨ä½äº`spaceid_bnb` æ¨¡å¼ä¹‹ä¸‹ã€‚æˆ‘ä»¬çš„ä¾èµ–æºæ–‡ä»¶`spaceid_bnb_sources.yml`çš„å®šä¹‰å¦‚ä¸‹ï¼š

```yml
version: 2

sources:
  - name: spaceid_bnb
    description: "bnb decoded tables related to SpaceId contract"
    freshness: # default freshness
      warn_after: { count: 12, period: hour }
      error_after: { count: 24, period: hour }
    tables:
      - name: BNBRegistrarControllerV3_evt_NameRegistered
        loaded_at_field: evt_block_time
      - name: BNBRegistrarControllerV4_evt_NameRegistered
        loaded_at_field: evt_block_time
      - name: BNBRegistrarControllerV5_evt_NameRegistered
        loaded_at_field: evt_block_time
      - name: BNBRegistrarControllerV6_evt_NameRegistered
        loaded_at_field: evt_block_time
      - name: BNBRegistrarControllerV7_evt_NameRegistered
        loaded_at_field: evt_block_time
      - name: BNBRegistrarControllerV8_evt_NameRegistered
        loaded_at_field: evt_block_time
      - name: BNBRegistrarControllerV9_evt_NameRegistered
        loaded_at_field: evt_block_time
```

åœ¨æˆ‘ä»¬å®šä¹‰çš„ä¾èµ–æºæ–‡ä»¶ä¸­ï¼š
1. `version` æ€»æ˜¯ä¸º`2`ã€‚
2. `name` æŒ‡å®šä¾èµ–æºæ•°æ®è¡¨çš„æ¨¡å¼ï¼ˆSchemaåç§°ï¼‰ã€‚æˆ‘ä»¬å¯ä»¥åœ¨Duneä¸Šæ–°å»ºæŸ¥è¯¢ï¼Œæœç´¢ç›¸å…³çš„è¡¨ï¼Œå°†è¡¨åæ·»åŠ åˆ°æŸ¥è¯¢ç¼–è¾‘å™¨ä¸­ï¼Œ`.`ç¬¦å·å·¦è¾¹çš„éƒ¨åˆ†å°±æ˜¯è¡¨çš„æ¨¡å¼åç§°ã€‚æ¯”å¦‚`spaceid_bnb.BNBRegistrarControllerV3_evt_NameRegistered` è¡¨çš„æ¨¡å¼åç§°å°±æ˜¯`spaceid_bnb`ã€‚
3. `freshness` è¿™ä¸ªè®¾ç½®ç”¨äºç¡®è®¤é­”æ³•è¡¨æ•°æ®çš„è‡ªåŠ¨æ›´æ–°ï¼Œå¦‚æœè¶…è¿‡æŒ‡å®šæ—¶é—´æœªæˆåŠŸæ›´æ–°ï¼Œåˆ™ä¼šåœ¨ä½¿ç”¨é­”æ³•è¡¨æ—¶å‘å‡ºè­¦å‘Šæˆ–æ˜¾ç¤ºé”™è¯¯ï¼ˆæˆ‘è‡ªå·±å°šæœªé‡åˆ°è¿‡æ­¤ç±»é”™è¯¯ï¼Œæ‰€ä»¥ä¹Ÿå¯èƒ½é”™è¯¯åªå‘é€ç»™ç»´æŠ¤é­”æ³•è¡¨æ¨¡å—çš„å·¥ä½œäººå‘˜ï¼‰ã€‚ä¿æŒç›¸åŒçš„é»˜è®¤è®¾ç½®å³å¯ã€‚è¿™é‡Œçš„è®¾ç½®å¯¹åç»­`tables`ä¸‹çš„æ‰€æœ‰æ•°æ®æ¥æºè¡¨éƒ½æœ‰æ•ˆã€‚å½“ç„¶ä¹Ÿå¯ä»¥å¯¹å•ä¸ªè¡¨æ·»åŠ æ­¤é¡¹è®¾ç½®ã€‚
4. `tables`éƒ¨åˆ†é€ä¸ªåˆ—å‡ºæˆ‘ä»¬éœ€è¦ç”¨åˆ°çš„æ•°æ®æ¥æºè¡¨ã€‚è¿™äº›è¡¨éœ€è¦éƒ½å½’å±äºä¸Šé¢æ¨¡å¼åç§°æŒ‡å®šçš„åŒä¸€ä¸ªæ¨¡å¼ã€‚å¦‚æœæœ‰å±äºä¸åŒæ¨¡å¼çš„è¡¨ï¼Œæˆ‘ä»¬å°±éœ€è¦åœ¨åŒä¸€ä¸ªæ–‡ä»¶ä¸­å•ç‹¬å†æ·»åŠ ä¸€æ®µç›¸åŒçš„ç»“æ„çš„å®šä¹‰ã€‚å¯å‚è€ƒå…¶ä»–å·²æœ‰çš„é­”æ³•è¡¨çš„æ¨¡å¼æ–‡ä»¶å®šä¹‰ã€‚
  - `name` è®¾ç½®è¡¨çš„åç§°ã€‚è¿™é‡Œä¸è¦åŒ…æ‹¬æ¨¡å¼åç§°ã€‚
  - `loaded_at_field` æŒ‡å®šç”¨äºæ£€æŸ¥éªŒè¯æœ€åå‡ è¡Œæ•°æ®çš„åŠ è½½æ—¶é—´ï¼Œéœ€è¦æŒ‡å®šä¸€ä¸ªæ—¶é—´æˆ³ç±»å‹å­—æ®µã€‚è¿™ä¸ªé…åˆ`freshness` è®¾ç½®ç¡®ä¿é­”æ³•è¡¨æ•°æ®çš„æ­£å¸¸æ›´æ–°ã€‚


å‚è€ƒæ–‡æ¡£ï¼š
- [ğŸ“™ è¯†åˆ«å’Œå®šä¹‰ä¾èµ–æº](https://dune.com/docs/zh/spellbook/how-to-cast-a-spell/4-identify-and-define-sources/)
- [æ•°æ®æº](https://dune.com/docs/zh/spellbook/getting-started/data-sources/)

## å®šä¹‰æ¨¡å¼æ–‡ä»¶

æ¨¡å¼æ–‡ä»¶`spaceid_bnb_schema.yml`æä¾›è¦åˆ›å»ºçš„é­”æ³•è¡¨çš„åç§°ã€å­—æ®µã€æè¿°ç­‰ä¿¡æ¯ï¼Œå·²ç»ç›¸åº”çš„é…ç½®ä¿¡æ¯ã€‚

```yml
version: 2

models:
  - name: spaceid_bnb_view_registrations
    meta:
      blockchain: bnb
      project: spaceid
      contributors: [springzh]
    config:
      tags: ['bnb','spaceid','name','registrations']
    description: >
       SpaceID V3, V4, V5, V6, V7, V8 & V9 Name Registered on BNB
    columns:
      - &version
        name: version
        description: "Contract version"
      - &block_time
        name: block_time
        description: "UTC event block time"
      - &name
        name: name
        description: "Name of the space ID"
        tests:
          - unique
      - &label
        name: label
        description: "Label of the space ID"
      - &owner
        name: owner
        description:  "Owner of the space ID"
      - &cost
        name: cost
        description:  "Cost spent to register the space id"
      - &expires
        name: expires
        description:  "Name expires date and time in unix timestamp format"
      - &contract_address
        name: contract_address
        description:  "Contract address that called to register the space id"
      - &tx_hash
        name: tx_hash
        description:  "Transaction hash"
      - &block_number
        name: block_number
        description: "Block number in which the transaction was executed"
      - &evt_index
        name: evt_index
        description: "Event index"
```

SpaceIDçš„å¤šä¸ªç‰ˆæœ¬çš„`NameRegistered`äº‹ä»¶è¡¨ç»“æ„å®Œå…¨ç›¸åŒï¼Œæ‰€ä»¥æˆ‘ä»¬çš„å·¥ä½œæ¯”è¾ƒç®€å•ï¼Œä½¿ç”¨å…¶ä¸­ä¸€ä¸ªè¡¨çš„ç»“æ„åšå‚è€ƒï¼Œå°±å¯ä»¥å®šä¹‰å‡ºæˆ‘ä»¬çš„æ¨¡å¼æ–‡ä»¶ã€‚ä¸ºäº†åŒºåˆ†åŸŸåæ³¨å†Œçš„æ¥æºï¼Œæˆ‘ä»¬æ·»åŠ ä¸€ä¸ª`version`å­—æ®µï¼Œä¿å­˜'v3'ã€'v4'è¿™æ ·çš„æ™ºèƒ½åˆçº¦ç‰ˆæœ¬ä¿¡æ¯ã€‚

å› ä¸ºåŸŸåæ˜¯å”¯ä¸€çš„ï¼Œæˆ‘ä»¬ç»™`name`å­—æ®µæ·»åŠ äº†ä¸€ä¸ªå”¯ä¸€æ€§çš„æµ‹è¯•å®šä¹‰ã€‚ç¼–è¯‘æ—¶ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªå¯¹åº”çš„æµ‹è¯•SQLï¼Œç”¨äºç¡®ä¿é­”æ³•è¡¨æ•°æ®ä¸­ä¸å­˜åœ¨é‡å¤å€¼ã€‚

`&field_name`å®šä¹‰å­—æ®µåç§°ã€‚åŒä¸€ä¸ªå­—æ®µåç§°ç¬¬ä¸€æ¬¡å‡ºç°æ—¶ï¼Œéœ€è¦å¸¦æœ‰â€œ&â€å‰ç¼€ã€‚åç»­åœ¨åŒä¸€ä¸ªæ–‡ä»¶ä¸­çš„å…¶ä»–è¡¨çš„å­—æ®µå®šä¹‰å¯ä»¥ä½¿ç”¨`*field_name`æ¥å¼•ç”¨ï¼Œè¿™æ ·å¯ä»¥è®©ä»£ç æ›´ç®€æ´ã€‚

## ç¼–å†™é­”æ³•è¡¨è§†å›¾çš„SQLè¯­å¥

æ¥ä¸‹æ¥æˆ‘ä»¬è¿›å…¥é­”æ³•è¡¨æœ€å…³é”®çš„SQLç¼–å†™éƒ¨åˆ†ã€‚æ‰“å¼€`spaceid_bnb_view_registrations.sql`æ–‡ä»¶ï¼Œè¾“å…¥å¦‚ä¸‹å†…å®¹ï¼ˆåšäº†éƒ¨åˆ†çœç•¥ï¼‰ï¼š

```sql
{{config(alias='view_registrations',
        post_hook='{{ expose_spells(\'["bnb"]\',
                                    "project",
                                    "spaceid",
                                    \'["springzh"]\') }}')}}
SELECT 'v3' as version,
    evt_block_time as block_time,
    name,
    label,
    owner,
    cast(cost as double) as cost,
    cast(expires as bigint) as expires,
    contract_address,
    evt_tx_hash as tx_hash,
    evt_block_number as block_number,
    evt_index
FROM {{source('spaceid_bnb', 'BNBRegistrarControllerV3_evt_NameRegistered')}}

UNION ALL

SELECT 'v4' as version,
    evt_block_time as block_time,
    name,
    label,
    owner,
    cast(cost as double) as cost,
    cast(expires as bigint) as expires,
    contract_address,
    evt_tx_hash as tx_hash,
    evt_block_number as block_number,
    evt_index
FROM {{source('spaceid_bnb', 'BNBRegistrarControllerV4_evt_NameRegistered')}}

-- æ­¤å¤„çœç•¥äº† V5 - V8çš„ä»£ç éƒ¨åˆ†

UNION ALL

-- There are some records in v9 table are duplicated with those in v5 table. So we join to exclude them
SELECT 'v9'                       as version,
       v9.evt_block_time          as block_time,
       v9.name,
       v9.label,
       v9.owner,
       cast(v9.cost as double)    as cost,
       cast(v9.expires as bigint) as expires,
       v9.contract_address,
       v9.evt_tx_hash             as tx_hash,
       v9.evt_block_number        as block_number,
       v9.evt_index
FROM {{source('spaceid_bnb', 'BNBRegistrarControllerV9_evt_NameRegistered')}} v9
LEFT JOIN {{source('spaceid_bnb', 'BNBRegistrarControllerV5_evt_NameRegistered')}} v5
    ON v9.name = v5.name
WHERE v5.name is null
```

è¯´æ˜å¦‚ä¸‹ï¼š
- å¼€å¤´çš„`config`å¯¹é­”æ³•è¡¨åšä¸€äº›é…ç½®è¯´æ˜ï¼Œéå¸¸å…³é”®ã€‚è¯·æ€»æ˜¯ä¿æŒç›¸åŒçš„æ ¼å¼ã€‚ä¹Ÿè¯·æ³¨æ„å•å¼•å·åŒå¼•å·åµŒå¥—æ—¶çš„è½¬ä¹‰å¤„ç†ã€‚å…¶ä¸­ï¼Œ`alias`æŒ‡å®šé­”æ³•è¡¨çš„åˆ«åï¼Œè¿™ä¸ªå°±æ˜¯ç”¨æˆ·åœ¨æŸ¥è¯¢ç¼–è¾‘å™¨ä¸­ç”¨åˆ°çš„é­”æ³•è¡¨åç§°ã€‚å»ºè®®ä½¿ç”¨è·Ÿåœ¨schemaä¸­å®šä¹‰çš„åç§°ã€‚`post_hook` é…ç½®é­”æ³•è¡¨æ„å»ºå®Œæˆå‘å¸ƒæ—¶çš„é™„åŠ æ“ä½œã€‚`expose_spells`è®¾ç½®å°†é­”æ³•è¡¨å±•ç¤ºåˆ°æŸ¥è¯¢ç¼–è¾‘å™¨ä¸­ï¼ˆå…¶ä»–ç”¨æˆ·å¯ä»¥æœç´¢æ‰¾åˆ°ï¼‰ã€‚å®ƒçš„å‚æ•°æŒ‰é¡ºåºåˆ†åˆ«è¡¨ç¤ºï¼Œé€‚é…çš„åŒºå—é“¾ï¼ˆæ•°ç»„ï¼‰ï¼Œé­”æ³•è¡¨çš„ç±»å‹ï¼ˆé¡¹ç›®ç±»å‹è¿˜æ˜¯è¡Œä¸šç±»å‹ï¼‰ï¼Œé¡¹ç›®æˆ–è¡Œä¸šçš„å‘½åï¼Œè´¡çŒ®è€…åˆ—è¡¨ï¼ˆæ•°ç»„ï¼‰ã€‚å…·ä½“åˆ°æˆ‘ä»¬è¿™ä¸ªé­”æ³•è¡¨ï¼Œå°±æ˜¯bnbåŒºå—é“¾ï¼Œprojectç±»å‹ï¼Œåç§°æ˜¯spaceidï¼Œè´¡çŒ®è€…å†™ä½ è‡ªå·±çš„githubè´¦å·åç§°ã€‚
- ä¸»ä½“éƒ¨åˆ†å°±æ˜¯ä¸€ä¸ªå®Œæ•´çš„SELECTæŸ¥è¯¢è¯­å¥ã€‚è·Ÿæˆ‘ä»¬å¹³å¸¸ç¼–å†™çš„æŸ¥è¯¢è¯­å¥çš„ä¸åŒä¹‹å¤„åœ¨äºï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ç‰¹æ®Šçš„JINJAæ¨¡ç‰ˆè¯­æ³•æ¥å¼•ç”¨æ•°æ®æºè¡¨ã€‚ä¾‹å¦‚`{{source('spaceid_bnb', 'BNBRegistrarControllerV9_evt_NameRegistered')}}` å°±æŒ‡å‘æˆ‘ä»¬åœ¨`spaceid_bnb_sources.yml`æ–‡ä»¶ä¸­å®šä¹‰çš„`BNBRegistrarControllerV9_evt_NameRegistered`è¡¨ã€‚
- åœ¨æäº¤PRç»™Dune Reviewä¹‹åï¼Œæˆ‘ä»¬æ”¶åˆ°æµ‹è¯•åé¦ˆï¼ŒåŸŸå`name`å­—æ®µçš„å”¯ä¸€æ€§æ£€æŸ¥æµ‹è¯•å¤±è´¥ã€‚ç»è¿‡æ£€æŸ¥ç¡®è®¤ï¼Œå‘ç°æ˜¯V9ç‰ˆæœ¬çš„è¡¨ä¸­åŒ…å«äº†éƒ¨åˆ†V5ä¸­çš„è®°å½•ï¼Œå¹¶ä¸”æ¥æºäºç›¸åŒçš„äº¤æ˜“è®°å½•ï¼ˆevt_tx_hashå€¼ç›¸åŒï¼‰ã€‚è¿™é‡Œçš„åŸå› å°šæœªç¡®å®šï¼Œä¸è¿‡æˆ‘ä»¬å°±å¯¹V9éƒ¨åˆ†çš„æŸ¥è¯¢åšäº†è°ƒæ•´ï¼Œæ’é™¤æ‰é‚£äº›å·²ç»åœ¨V5ä¸­çš„è®°å½•ã€‚

å‚è€ƒæ–‡æ¡£ï¼š
- [ğŸ¨ é…ç½®åˆ«åå’Œç‰©åŒ–ç­–ç•¥](https://dune.com/docs/zh/spellbook/how-to-cast-a-spell/7-configure-alias-and-materialization-strategy/)
- [ğŸ–‹ï¸ å°†æ‚¨çš„é­”æ³•è¡¨å†™æˆ SELECT è¯­å¥](https://dune.com/docs/zh/spellbook/how-to-cast-a-spell/6-write-your-spell-as-SELECT-statement/)

å†™å¥½æŸ¥è¯¢è¯­å¥åï¼Œæˆ‘ä»¬å¯ä»¥å…ˆä½¿ç”¨`dbt compile`å°è¯•ç¼–è¯‘ã€‚å¦‚æœè¿”å›é”™è¯¯ï¼Œè¯·é’ˆå¯¹æ€§ä¿®æ”¹åå†æ¬¡ç¼–è¯‘ï¼Œç¡®ä¿ç¼–è¯‘æˆåŠŸã€‚

## å°†æ–°æ¨¡å‹æ·»åŠ åˆ° dbt_project.yml æ–‡ä»¶

æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦ä¿®æ”¹ä½äºspellbookæ ¹ç›®å½•ä¸‹çš„`dbt_project.yml`æ–‡ä»¶ï¼Œå°†æˆ‘ä»¬çš„é­”æ³•è¡¨åŠ å…¥å…¶ä¸­ã€‚

```
    spaceid:
      +schema: spaceid
      bnb:
        +schema: spaceid_bnb
```

è¿™é‡Œæˆ‘ä»¬åˆ†å§æŒ‡å®šäº†é¡¹ç›®åç§°å’Œé¡¹ç›®çš„æ¨¡å¼åç§°ï¼Œå·²ç»é¡¹ç›®å¯¹åº”çš„åŒºå—é“¾åç§°å’Œåœ¨è¯¥åŒºå—é“¾ä¸‹çš„æ¨¡å¼åç§°ã€‚é€šè¿‡è¿™æ ·çš„å±‚çº§ç»“æ„ï¼Œæˆ‘ä»¬å¯ä»¥è¿›è¡Œåˆ†å±‚æŠ½è±¡å¤„ç†ï¼Œå…ˆé’ˆå¯¹æ¯ä¸ªéƒ¨ç½²åœ¨ä¸åŒåŒºå—é“¾ä¸Šçš„é¡¹ç›®æ„å»ºé­”æ³•è¡¨ï¼Œç„¶åå¯ä»¥è¿›ä¸€æ­¥å°†å¤šä¸ªåŒºå—é“¾ä¸Šçš„ç›¸åŒé¡¹ç›®çš„é­”æ³•è¡¨è¿›ä¸€æ­¥æ„å»ºä¸ºæ•´ä¸ªé¡¹ç›®å±‚çº§çš„é­”æ³•è¡¨ã€‚å…·ä½“çš„ä¾‹å­å¯ä»¥å‚è€ƒopenseaæˆ–è€…uniswapç›¸å…³çš„é­”æ³•è¡¨ã€‚

é­”æ³•è¡¨çš„é»˜è®¤ç‰©åŒ–ç­–ç•¥æ˜¯ç”Ÿæˆè§†å›¾ï¼ˆViewï¼‰ï¼Œå¦‚æœè¦ç”Ÿæˆå¢é‡è¡¨ï¼ˆIncrementalï¼‰æˆ–è€…ç‰©ç†è¡¨ï¼ˆTableï¼‰ï¼Œè¿˜éœ€è¦æŒ‡å®šå…·ä½“çš„ç‰©åŒ–ç­–ç•¥ã€‚æˆ‘ä»¬è¿™é‡Œä½¿ç”¨é»˜è®¤çš„è§†å›¾ç‰©åŒ–ç­–ç•¥ï¼Œæ‰€ä»¥ä¸éœ€è¦é¢å¤–è®¾ç½®ã€‚
æ•´ä¸ªé¡¹ç›®æŒ‡å®šé¡¹ç›®åç§°ã€æ¨¡å¼å’Œç‰©åŒ–ç­–ç•¥ï¼Œä»¥åŠæˆ‘ä»¬ä¸ºå…¶åˆ›å»ºé­”æ³•è¡¨çš„ç‰¹å®šåŒºå—é“¾ã€‚

å¯ä»¥å†æ¬¡ä½¿ç”¨`dbt compile`å°è¯•ç¼–è¯‘ï¼Œç¡®è®¤ç¼–è¯‘æˆåŠŸã€‚

å‚è€ƒæ–‡æ¡£ï¼š
- [ğŸ¨ é…ç½®åˆ«åå’Œç‰©åŒ–ç­–ç•¥](https://dune.com/docs/zh/spellbook/how-to-cast-a-spell/7-configure-alias-and-materialization-strategy/)

## ç¼–å†™æµ‹è¯•

æˆ‘ä»¬éœ€è¦ç¡®ä¿ç”Ÿæˆçš„é­”æ³•è¡¨æ•°æ®æ˜¯å®Œæ•´ä¸”å‡†ç¡®çš„ï¼Œé€šè¿‡ç¼–å†™åˆç†çš„æµ‹è¯•å¯ä»¥è¾¾åˆ°è¿™ä¸ªç›®çš„ã€‚åœ¨`spellbook/test`ç›®å½•ä¸‹åˆ›å»ºæ–°çš„ç›®å½•è·¯å¾„`spaceid/bnb`ï¼Œè¿›å…¥bnbå­ç›®å½•ï¼Œåœ¨å…¶ä¸­åˆ›å»ºä¸€ä¸ªæ–‡ä»¶`spaceid_view_registrations_test.sql`ï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š

```
WITH unit_tests AS (
    SELECT COUNT(*) as count_spell
    FROM {{ ref('spaceid_bnb_view_registrations') }} AS s
    WHERE version = 'v7'
),

spaceid_v7_registration as (
    SELECT COUNT(*) as count_event_table
    FROM {{source('spaceid_bnb', 'BNBRegistrarControllerV7_evt_NameRegistered')}}
)
SELECT 1
FROM unit_tests
JOIN spaceid_v7_registration ON TRUE
WHERE count_spell - count_event_table <> 0
```

æˆ‘ä»¬åœ¨è¿™ä¸ªæµ‹è¯•ä¸­ï¼Œä½¿ç”¨`{{ ref('spaceid_bnb_view_registrations') }}` çš„å½¢å¼æ¥å¼•ç”¨ç”Ÿæˆçš„é­”æ³•è¡¨ã€‚é¦–å…ˆï¼Œä»ç”Ÿæˆçš„é­”æ³•è¡¨ä¸­æŸ¥å‡ºV7ç‰ˆæœ¬çš„æ‰€æœ‰è®°å½•æ•°ã€‚ç„¶åæˆ‘ä»¬å†ä½¿ç”¨`{{source('spaceid_bnb', 'BNBRegistrarControllerV7_evt_NameRegistered')}}ï¼Œä»å¯¹åº”çš„V7è§£æè¡¨æŸ¥è¯¢è®°å½•æ•°é‡ã€‚æœ€åæ£€æŸ¥è¿™ä¸¤ä¸ªCTEè¿”å›çš„è®°å½•æ•°é‡æ˜¯å¦ç›¸åŒã€‚å¦‚æœä¸åŒï¼Œåˆ™ä¼šè¿”å›ä¸€è¡Œç»“æœè®°å½•ã€‚ä¸€ä¸ªæˆåŠŸçš„æµ‹è¯•å¿…é¡»ä¸è¿”å›ä»»ä½•ç»“æœé›†ã€‚è¿”å›ä»»æ„è®°å½•åˆ™è¡¨ç¤ºæµ‹è¯•å¤±è´¥ã€‚

å‚è€ƒæ–‡æ¡£ï¼š[å¦‚ä½•ä¸ºæ‚¨çš„é­”æ³•ç¼–å†™å•å…ƒæµ‹è¯•ï¼Ÿ](https://dune.com/docs/zh/spellbook/getting-started/tests/)

## ç¼–è¯‘ä¸è°ƒè¯•

å½“æˆ‘ä»¬ç¼–è¾‘å¹¶ä¿å­˜äº†æµ‹è¯•æ–‡ä»¶ä¹‹åï¼Œéœ€è¦å†æ¬¡ä½¿ç”¨`dbt compile`è¿›è¡Œç¼–è¯‘ï¼Œä¿®æ”¹æç¤ºçš„ä»»ä½•é”™è¯¯ï¼Œç¡®è®¤ç¼–è¯‘æˆåŠŸã€‚

æ­¤æ—¶ï¼Œæˆ‘ä»¬è¿˜éœ€è¿›è¡Œä¸€ä¸ªéå¸¸é‡è¦çš„æ­¥éª¤ï¼Œå¤åˆ¶ç¼–è¯‘ç”Ÿæˆçš„æŸ¥è¯¢ä»£ç ï¼Œåœ¨Duneä¸Šè¿›è¡Œå®é™…çš„æµ‹è¯•éªŒè¯ã€‚

ç¼–è¯‘æˆåŠŸæ—¶ï¼Œåœ¨`spellbook`ç›®å½•ä¸‹ä¼šç”Ÿæˆ`target`å­ç›®å½•ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å…¶ä¸­æ‰¾åˆ°`compiled/spellbook/models/spaceid/bnb`å­ç›®å½•ï¼Œå…¶ä¸­ä¼šæœ‰ä¸€ä¸ª`spaceid_bnb_view_registrations.sql`æ–‡ä»¶ã€‚è¿™ä¸ªå°±æ˜¯æˆ‘ä»¬æ­£åœ¨æ„å»ºçš„é­”æ³•è¡¨èƒŒåçš„è§†å›¾å®šä¹‰SQLã€‚ç›®å½•ä¸‹è¿˜æœ‰ä¸€ä¸ª`spaceid_bnb_schema.yml`çš„å­ç›®å½•ï¼Œé‡Œé¢ä¿å­˜çš„æ˜¯æ ¹æ®æ¨¡å¼å®šä¹‰è‡ªåŠ¨ç”Ÿæˆçš„æµ‹è¯•ï¼Œè¿™éƒ¨åˆ†æˆ‘ä»¬å¯ä»¥å¿½ç•¥ã€‚

åŒæ—¶ï¼Œåœ¨`spellbook/target/compiled/spellbook/tests/spaceid/bnb`ç›®å½•ä¸‹ä¹Ÿä¼šç”Ÿæˆä¸€ä¸ªè·Ÿæˆ‘ä»¬å‰é¢æ­¥éª¤ä¸­ç¼–å†™çš„æµ‹è¯•åŒåçš„æ–‡ä»¶`spaceid_view_registrations_test.sql`ã€‚

æˆ‘ä»¬é¦–å…ˆå¯¹`spaceid_bnb_view_registrations.sql`æ–‡ä»¶è¿›è¡Œæ‰‹åŠ¨æµ‹è¯•ã€‚å› ä¸ºæ•°æ®é‡å¾ˆå¤§ï¼Œå¹¶ä¸é€‚åˆç›´æ¥è¿è¡Œæ–‡ä»¶é‡Œé¢çš„SQLè¿”å›æ‰€æœ‰è®°å½•ã€‚æˆ‘ä»¬å¯ä»¥è¿™æ ·æµ‹è¯•ï¼šå¤åˆ¶æ–‡ä»¶çš„å…¨éƒ¨å†…å®¹ï¼Œå°†å…¶æ”¾åˆ°ä¸€ä¸ªCTEå®šä¹‰ä¸­ï¼Œç„¶åé’ˆå¯¹è¯¥CTEè¿›è¡Œè‡³è¿”å›å°‘é‡æ•°æ®çš„æŸ¥è¯¢ã€‚

```sql
with view_registration as (
SELECT 'v3'                    as version,
       evt_block_time          as block_time,
       name,
       label,
       owner,
       cast(cost as double)    as cost,
       cast(expires as bigint) as expires,
       contract_address,
       evt_tx_hash             as tx_hash,
       evt_block_number        as block_number,
       evt_index
FROM spaceid_bnb.BNBRegistrarControllerV3_evt_NameRegistered

-- æ­¤å¤„çœç•¥åç»­ä»£ç 

)

select * from view_registration
limit 1000
```

å®Œæ•´çš„æ‰‹åŠ¨æµ‹è¯•æŸ¥è¯¢ä»£ç ï¼š[https://dune.com/queries/2020131](https://dune.com/queries/2020131)

è¿™ä¸€æ­¥æµ‹è¯•çš„ä¸»è¦ç›®çš„æ˜¯ç¡®ä¿ç¼–è¯‘ç”Ÿæˆçš„SQLè¯­å¥åœ¨Duneä¸Šå¯ä»¥æ­£å¸¸è¿è¡Œã€‚å½“ç„¶ä½ å¯ä»¥ä¿®æ”¹æœ€åçš„è¾“å‡ºæŸ¥è¯¢è¯­å¥ï¼Œåšæ›´å¤šçš„æ‰‹åŠ¨æµ‹è¯•ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¤åˆ¶æ–‡ä»¶`spaceid_view_registrations_test.sql`çš„å…¨éƒ¨å†…å®¹ï¼Œåœ¨Duneä¸Šæ‰§è¡ŒéªŒè¯ï¼Œç¡®è®¤SQLæ‰§è¡Œæ­£å¸¸å¹¶ä¸”ä¸è¿”å›ä»»ä½•è®°å½•ã€‚

```sql
WITH unit_tests AS (
    SELECT COUNT(*) as count_spell
    FROM {{ ref('spaceid_bnb_view_registrations') }} AS s
    WHERE version = 'v7'
),

spaceid_v7_registration as (
    SELECT COUNT(*) as count_event_table
    FROM {{source('spaceid_bnb', 'BNBRegistrarControllerV7_evt_NameRegistered')}}
)
SELECT 1
FROM unit_tests
JOIN spaceid_v7_registration ON TRUE
WHERE count_spell - count_event_table <> 0
```

## æäº¤PR

ç°åœ¨æˆ‘ä»¬å·²ç»å¤„ç†å¥½æ–°çš„é­”æ³•è¡¨å¹¶ä¸”å®Œæˆäº†æœ¬åœ°æµ‹è¯•ã€‚å·²ç»å‡†å¤‡å¥½å°†æ–°å¢å’Œä¿®æ”¹è¿‡çš„æ–‡ä»¶å†…å®¹æäº¤åˆ°Githubä»£ç åº“ä¸­ï¼Œå‘Duneæäº¤PRã€‚

æˆ‘ä»¬é¦–å…ˆå°†æœ¬åœ°æ–°å»ºå’Œä¿®æ”¹çš„ä»£ç æ–‡ä»¶æ·»åŠ å¹¶æäº¤åˆ°æœ¬åœ°git å­˜è´®åº“ï¼Œç„¶åå°†æœ¬åœ°çš„åˆ†æ”¯æ¨é€åˆ°è¿œç¨‹Githubå­˜è´®åº“ä¸­ï¼š

```
# æŸ¥çœ‹å¹¶ç¡®è®¤æ–°å¢æˆ–ä¿®æ”¹è¿‡çš„æ–‡ä»¶åŠç›®å½•
git status

# å°†æ‰€æœ‰æ–°å¢å’Œä¿®æ”¹è¿‡çš„æ–‡ä»¶åŠ å…¥æäº¤
git add .

# æäº¤åˆ°æœ¬åœ°gitå­˜è´®åº“
git commit -m 'Add spaceid view'

# å°†æœ¬åœ°å­˜è´®åº“åˆ†æ”¯æ¨é€åˆ°è¿œç¨‹Githubåº“ä¸­
git push -u origin add_bnb_spaceid

```

ä¸Šé¢çš„æ¨é€å‘½ä»¤ä¸­çš„å‚æ•°éƒ¨åˆ†`-u origin add_bnb_spaceid`ä»…åœ¨ç¬¬ä¸€æ¬¡æ¨é€æ—¶æ‰éœ€è¦ã€‚å½“æˆ‘ä»¬å®Œæˆç¬¬ä¸€æ¬¡æ¨é€åï¼Œå¦‚æœåç»­åˆå¯¹ç›¸å…³æ–‡ä»¶åšäº†ä¿®æ”¹ï¼Œåˆ™åœ¨æäº¤åˆ°æœ¬åœ°gitåº“ä¸­åï¼Œæ¨é€åˆ°è¿œç¨‹æ—¶ä½¿ç”¨çš„å‘½ä»¤éœ€è¦æ”¹æˆï¼š

```
git push
```

ç„¶åï¼Œæˆ‘ä»¬æ‰“å¼€githubç½‘ç«™ï¼Œè¿›å…¥æˆ‘ä»¬çš„ä¸ªäººè´¦å·ä¸‹çš„`spellbook`å­˜è´®åº“é¡µé¢ã€‚å¯ä»¥çœ‹åˆ°æç¤ºä¿¡æ¯ï¼Œå‘Šè¯‰æˆ‘ä»¬æœ‰æ–°çš„åˆ†æ”¯`add_bnb_spaceid`æäº¤äº†æœ€æ–°ä¿®æ”¹ï¼Œå¯ä»¥ä¸ºå…¶åˆ›å»ºPull Requestï¼ˆå³PR)ã€‚ç‚¹å‡»åˆ›å»ºPRæŒ‰é’®ï¼Œåˆ™ä¼šè¿›å…¥PRåˆ›å»ºé¡µé¢ã€‚

åœ¨è¿™ä¸ªPRé¡µé¢ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ç¼–è¾‘è¾“å…¥ä¸€ä¸‹å†…å®¹ï¼ŒåŒæ—¶ç¡®è®¤æˆ‘ä»¬å·²ç»æŒ‰ç…§æ–‡æ¡£æŒ‡å¯¼å®Œæˆäº†ç›¸åº”çš„æ£€æŸ¥å’Œæµ‹è¯•å·¥ä½œã€‚è¿™ä¸ªå†…å®¹ç¼–è¾‘å™¨æ”¯æŒMarkdownè¯­æ³•ï¼Œ`[ ]`å°†ä¼šè¾“å‡ºä¸€ä¸ªæœªå‹¾é€‰çš„checkboxï¼Œ`[x]`åˆ™ä¼šè¾“å‡ºä¸€ä¸ªå‹¾é€‰çŠ¶æ€çš„checkboxã€‚æˆ‘ä»¬é€ä¸€è°ƒæ•´è¿™äº›é€‰é¡¹ï¼Œç¡®è®¤å·²å®Œæˆäº†ç›¸åº”çš„æ­¥éª¤å’Œå¤„ç†ã€‚

æˆ‘ä»¬è¿˜éœ€è¦é’ˆå¯¹è¿™ä¸ªPRæ‰€æ–°å¢æˆ–è€…ä¿®æ”¹çš„Spellæä¾›ä¸€äº›ç®€è¦çš„è¯´æ˜ä¿¡æ¯ï¼Œä»¥æ–¹ä¾¿å®¡æ ¸äººå‘˜å¯ä»¥æ›´å®¹æ˜“äº†è§£å…¶ä¸­æ¶‰åŠçš„å†…å®¹ã€‚

![image_03.jpg](img/image_03.jpg)

æäº¤PRåï¼Œæˆ‘ä»¬éœ€è¦ç­‰å¾…ç›¸å…³äººå‘˜Reviewå¹¶æä¾›åé¦ˆã€‚åŒæ—¶ï¼Œéœ€è¦ç•™æ„æ¥è‡ªGithubçš„é‚®ä»¶é€šçŸ¥ã€‚å…¶ä¸­ä¸€äº›é€šçŸ¥ä¿¡æ¯å¯ä»¥å¿½ç•¥ï¼Œæ¯”å¦‚å…³äº`dbt slim ci (in beta) / dbt-test`çš„ã€‚ä¸»è¦éœ€è¦æ³¨æ„çš„æ˜¯Reviewäººå‘˜æä¾›çš„åé¦ˆç‚¹è¯„ã€‚å¦‚æœæœ‰éœ€è¦ä¿®æ”¹çš„å†…å®¹ï¼Œå°±è¦åŠæ—¶ä¿®æ”¹ã€æµ‹è¯•ã€æäº¤ä¿®æ”¹ã€æ¨é€åˆ°Githubï¼ˆæ­¤æ—¶ä¿®æ”¹ä¼šè‡ªåŠ¨å‡ºç°åœ¨å·²ç»åˆ›å»ºçš„PRä¸‹ï¼Œæ— éœ€å†æ¬¡åˆ›å»ºæ–°çš„PRï¼‰ï¼Œå¹¶ç­‰å¾…å†æ¬¡Reviewã€‚

å¦‚æœæ‰€æœ‰çš„ä¿®æ”¹éƒ½é¡ºåˆ©é€šè¿‡äº†Reviewï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„PRå°±ä¼šè¢«åˆå¹¶åˆ°spellbookä¸»åˆ†æ”¯ï¼Œå¹¶è¢«éƒ¨ç½²åˆ°Duneæ­£å¼ç«™ç‚¹ã€‚éƒ¨ç½²å®Œæˆåï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨æŸ¥è¯¢ç¼–è¾‘å™¨ä¸­æœç´¢æ‰¾åˆ°å¹¶ä½¿ç”¨æˆ‘ä»¬è‡ªå·±æ„å»ºçš„é­”æ³•è¡¨äº†ã€‚å¤§åŠŸå‘Šæˆï¼

## è¡¥å……è¯´æ˜ä¸ç‰¹åˆ«é¸£è°¢

æ³¨æ„ï¼šæˆªæ­¢åˆ°æœ¬æ–‡å‘ç¨¿æ—¶ï¼Œæˆ‘ä»¬çš„è¿™ä¸ªPRè¿˜åœ¨Reviewè¿‡ç¨‹ä¸­ï¼Œå°šæœªè¢«æ‰¹å‡†é€šè¿‡ã€‚æ‰€ä»¥åç»­å¯èƒ½è¿˜ä¼šæ ¹æ®åé¦ˆå»ºè®®è¿›è¡Œä¿®æ”¹è°ƒæ•´ã€‚è¿™ä¸ªPRçš„ç¼–å·æ˜¯2725ï¼Œå¤§å®¶å¯ä»¥é€šè¿‡PRé¡µé¢æ¥äº†è§£ç›¸å…³çš„ç»†èŠ‚ã€‚

PRçš„Githubé“¾æ¥ï¼š[Add BNB spaceid view](https://github.com/duneanalytics/spellbook/pull/2725)

ç‰¹åˆ«é¸£è°¢ç¤¾åŒºæˆå‘˜ @hosuke (Dune: [https://dune.com/hosuke](https://dune.com/hosuke)åŠæ—¶ååŠ©PRçš„Reviewï¼Œæä¾›é—®é¢˜åé¦ˆå’Œå®Œå–„å»ºè®®ï¼Œå¹¶å¸®å¿™ä¿®æ”¹äº†é­”æ³•è¡¨çš„ç‰©åŒ–ç­–ç•¥éƒ¨åˆ†ã€‚

## SixDegreeLabä»‹ç»

SixDegreeLabï¼ˆ[@SixdegreeLab](https://twitter.com/sixdegreelab)ï¼‰æ˜¯ä¸“ä¸šçš„é“¾ä¸Šæ•°æ®å›¢é˜Ÿï¼Œæˆ‘ä»¬çš„ä½¿å‘½æ˜¯ä¸ºç”¨æˆ·æä¾›å‡†ç¡®çš„é“¾ä¸Šæ•°æ®å›¾è¡¨ã€åˆ†æä»¥åŠæ´è§ï¼Œå¹¶è‡´åŠ›äºæ™®åŠé“¾ä¸Šæ•°æ®åˆ†æã€‚é€šè¿‡å»ºç«‹ç¤¾åŒºã€ç¼–å†™æ•™ç¨‹ç­‰æ–¹å¼ï¼ŒåŸ¹å…»é“¾ä¸Šæ•°æ®åˆ†æå¸ˆï¼Œè¾“å‡ºæœ‰ä»·å€¼çš„åˆ†æå†…å®¹ï¼Œæ¨åŠ¨ç¤¾åŒºæ„å»ºåŒºå—é“¾çš„æ•°æ®å±‚ï¼Œä¸ºæœªæ¥å¹¿é˜”çš„åŒºå—é“¾æ•°æ®åº”ç”¨åŸ¹å…»äººæ‰ã€‚

æ¬¢è¿è®¿é—®[SixDegreeLabçš„Duneä¸»é¡µ](https://dune.com/sixdegree)ã€‚

å› æ°´å¹³æ‰€é™ï¼Œä¸è¶³ä¹‹å¤„åœ¨æ‰€éš¾å…ã€‚å¦‚æœ‰å‘ç°ä»»ä½•é”™è¯¯ï¼Œæ•¬è¯·æŒ‡æ­£ã€‚
